<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Bigelow Case â€” Flowchart</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.6.1/mermaid.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:ital,wght@0,400;0,500;1,400&family=Playfair+Display:wght@400;600&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PALETTE & TOKENS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --green:       #3a4543;
  --green-light: #4e5f5c;
  --green-dim:   #2a3230;
  --red:         #81322d;
  --red-light:   #9e3e38;
  --red-dim:     #5c201c;
  --yellow:      #ffe452;
  --yellow-dim:  #c9b53f;
  --orange:      #ff5025;
  --orange-dim:  #c93d1c;
  --edge:        #d7d7cf;
  --arrow:       #c5c5c3;
  --bg:          #0e1210;
  --bg2:         #161a18;
  --bg3:         #1c211e;
  --text:        #e4e2dc;
  --text-dim:    #8a8880;
  --border:      #272c29;
  --radius:      5px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESET
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
*,*::before,*::after { box-sizing:border-box; margin:0; padding:0; }
html, body {
  width:100%; height:100%;
  overflow:hidden;
  background:var(--bg);
  color:var(--text);
  font-family:'DM Sans',sans-serif;
  font-size:14px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FIXED CHROME
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#shell {
  position:fixed;
  top:0; left:0; right:0;
  z-index:200;
  padding-top:env(safe-area-inset-top);
  background:var(--bg2);
}

header {
  border-bottom:1px solid var(--border);
  padding:10px 20px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:16px;
}
.hdr-content { flex:1; min-width:0; }
.hdr-title {
  font-family:'Playfair Display',serif;
  font-size:15px;font-weight:600;
  color:var(--text);letter-spacing:.02em;
  white-space:normal; line-height:1.2;
}
.hdr-sub {
  font-family:'DM Mono',monospace;
  font-size:10px;color:var(--text-dim);
  letter-spacing:.08em;text-transform:uppercase;margin-top:4px;
  white-space:normal; line-height:1.3;
}

/* Toggle Header Button */
.btn-collapse {
  background:var(--bg3);
  border:1px solid var(--border);
  border-radius:6px;
  color:var(--text);
  padding:6px;
  cursor:pointer;
  display:flex; align-items:center; justify-content:center;
  transition:all 0.2s ease;
}
.btn-collapse:hover { background:var(--green-dim); border-color:var(--green); }
.btn-collapse svg { transition:transform 0.3s ease; }

.badges { display:flex;gap:6px;flex-wrap:wrap;flex-shrink:0; }
.badge {
  font-family:'DM Mono',monospace;font-size:9px;
  letter-spacing:.06em;padding:3px 8px;
  border-radius:3px;text-transform:uppercase;font-weight:500;
}
.b-red    { background:var(--red-dim);  color:#e8a09d;border:1px solid var(--red); }
.b-green  { background:var(--green-dim);color:#8aada8;border:1px solid var(--green); }
.b-yellow { background:#1e1a00;         color:var(--yellow);border:1px solid var(--yellow-dim); }
.b-orange { background:#1a0c00;         color:#ff8a6a;border:1px solid var(--orange-dim); }

.legend {
  background:var(--bg2);
  border-bottom:1px solid var(--border);
  padding:8px 20px;
  display:flex;align-items:center;gap:12px;flex-wrap:wrap;
  transition: max-height 0.3s ease, padding 0.3s ease;
  overflow: hidden;
}
.lg-label {
  font-family:'DM Mono',monospace;font-size:9px;
  letter-spacing:.08em;text-transform:uppercase;color:var(--text-dim);
}
.lg-item {
  display:flex;align-items:center;gap:6px;
  font-family:'DM Mono',monospace;font-size:9px;
  color:var(--text-dim);letter-spacing:.04em;
}
.lg-dot { width:9px;height:9px;border-radius:2px;flex-shrink:0; }
.lg-sep { width:1px; height:14px; background:var(--border); margin:0 4px; }

/* Collapsed state */
#shell.collapsed .legend { display:none; }
#shell.collapsed .btn-collapse svg { transform:rotate(180deg); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ZOOM WIDGET
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#zoom-widget {
  position:fixed;
  right:16px;
  z-index:300;
  display:flex; flex-direction:column; align-items:center; gap:4px;
  padding:9px 7px;
  background:var(--bg2);
  border:1px solid var(--border); border-top:none;
  border-radius:0 0 var(--radius) var(--radius);
  box-shadow:0 6px 24px rgba(0,0,0,.55);
}
.zb {
  width:30px;height:30px;
  background:var(--bg3); border:1px solid var(--border); border-radius:4px;
  color:var(--text); font-size:15px;line-height:1; cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  -webkit-tap-highlight-color:transparent; user-select:none;
  transition:background .1s,border-color .1s;
}
.zb:hover { background:var(--green-dim);border-color:var(--green); }
.zb:active { transform:scale(.9); }
.z-level {
  font-family:'DM Mono',monospace; font-size:10px;color:var(--text-dim);
  letter-spacing:.05em; padding:2px 0;min-width:34px;text-align:center;
}
.z-sep { width:22px;height:1px;background:var(--border);margin:2px 0; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PAN / ZOOM VIEWPORT (Removed hardware acceleration to fix blur)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#viewport {
  position:fixed; left:0; right:0;
  overflow:hidden; cursor:grab; touch-action:none;
  -webkit-user-select:none; user-select:none;
  contain:strict;
}
#viewport.grabbing { cursor:grabbing; }

#canvas {
  position:absolute; top:0; left:0;
  transform-origin:0 0;
  contain:layout;
  /* explicitly removed will-change and translate3d to force sharp vector scaling */
}

.mermaid { display:inline-block; padding:40px; }
.mermaid svg {
  display:block; max-width:none !important;
  shape-rendering:geometricPrecision; text-rendering:optimizeLegibility;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MEDIA TOOLTIP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#media-tooltip {
  position:fixed; z-index:9999; pointer-events:none;
  max-width:340px; min-width:200px;
  opacity:0;
  transform:translate(var(--ttx,-9999px),var(--tty,-9999px)) scale(.96);
  transition:opacity .14s ease, transform .14s ease;
}
#media-tooltip.vis {
  opacity:1; pointer-events:auto;
  transform:translate(var(--ttx,0px),var(--tty,0px)) scale(1);
}
.tt-inner {
  background:var(--bg2); border:1px solid var(--border); border-radius:6px;
  overflow:hidden; box-shadow:0 8px 32px rgba(0,0,0,.72),0 1px 4px rgba(0,0,0,.4);
}
.tt-media { width:100%; display:block; background:#000; max-height:220px; object-fit:contain; }
.tt-cap {
  padding:10px 14px; font-family:'DM Mono',monospace;
  font-size:11px;color:var(--text-dim); line-height:1.5; border-top:1px solid var(--border);
}
.tt-id { font-size:9px;letter-spacing:.1em;text-transform:uppercase; color:var(--green-light);margin-bottom:4px;opacity:.65; }
.tt-empty { padding:14px;font-family:'DM Mono',monospace;font-size:11px;color:var(--text-dim);opacity:.4;text-align:center; }
.tt-hint-mobile { display:none; font-size:9px; color:var(--text-dim); opacity:0.6; margin-top:8px; text-align:center; font-style:italic; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MOBILE RESPONSIVE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media (max-width: 768px) {
  header { padding:8px 12px; }
  .hdr-title { font-size:13px; }
  .hdr-sub { font-size:9px; }
  .btn-collapse { padding:5px; }
  .legend { padding:8px 12px; gap:8px; justify-content:center; }
  .lg-item { font-size:8px; }
  .lg-label, .lg-sep { display:none; }
  .badges { width:100%; justify-content:center; margin-bottom:4px; }
  
  #zoom-widget { right:8px; padding:6px 5px; }
  .zb { width:26px; height:26px; font-size:13px; }
  .z-level { min-width:30px; font-size:9px; }

  /* Tooltip docks to the bottom safely on mobile */
  #media-tooltip.vis {
    transform:translate(-50%, 0) scale(1) !important;
    top:auto !important; bottom:20px !important; left:50% !important;
    width:calc(100vw - 32px) !important; max-width:360px !important;
  }
  .tt-hint-mobile { display:block; }
  .tt-inner { box-shadow:0 12px 40px rgba(0,0,0,0.85), 0 1px 8px rgba(0,0,0,0.6); }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BOTTOM HINT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#hint {
  position:fixed;bottom:14px;left:16px;z-index:300;
  font-family:'DM Mono',monospace;font-size:9px;
  color:var(--text-dim);letter-spacing:.06em;text-transform:uppercase;
  background:var(--bg2);border:1px solid var(--border);
  border-radius:3px;padding:5px 9px;opacity:.6; pointer-events:none;
  transition:opacity 1.2s ease;
}
#hint.gone { opacity:0; }
</style>
</head>
<body>

<!-- MEDIA DATA -->
<script>
const mediaData = {
  "INC3": { type:"image", url:"https://github.com/kbigelo/23cf1829/blob/main/frame_00000725.png?raw=true", caption:"3 bullet holes â€” garage ceiling + windshield" },
  "INC5": { type:"video", url:"https://example.com/video/acoustic.mp4", caption:"Acoustic impossibility â€” expert analysis" },
  "C3":   { type:"video", url:"https://example.com/video/bodycam-010050.mp4", caption:"Staat approaches â€” 01:00:50, left hand concealed" },
  "C5":   { type:"video", url:"https://example.com/video/bodycam-patdown.mp4", caption:"Unlawful pat-down â€” 01:00:55â€“01:01:05" },
  "C8":   { type:"video", url:"https://example.com/video/bodycam-holster.mp4", caption:"Staat hand to holster â€” 01:01:25" },
  "C10":  { type:"video", url:"https://example.com/video/bodycam-consent.mp4", caption:"Coerced consent â€” 01:01:54" },
  "SV1":  { type:"video", url:"https://example.com/video/bodycam-phone.mp4", caption:"Phone moved after prohibition â€” 01:03:26" },
  "SV5":  { type:"video", url:"https://example.com/video/bodycam-bag.mp4", caption:"Sealed rifle bag unzipped â€” 01:06:46â€“01:06:50" },
  "CI3":  { type:"video", url:"https://example.com/video/bodycam-attorney.mp4", caption:"Panas interrupts attorney call â€” 01:11:49" },
  "PS1":  { type:"video", url:"https://example.com/video/bodycam-010206.mp4", caption:"Staat: 'Maintenance might have given us the wrong one' â€” 01:02:06" },
  "PS2":  { type:"video", url:"https://example.com/video/bodycam-phone-touch.mp4", caption:"Staat touches phone â€” 01:03:26" }
};
</script>

<!-- CHROME SHELL -->
<div id="shell">
  <header>
    <div class="hdr-content">
      <div class="hdr-title">State v. Bigelow â€” Constitutional Violations Map</div>
      <div class="hdr-sub">Suppression Analysis Â· Franks v. Delaware Â· Wong Sun Chain</div>
    </div>
    <button id="btn-collapse" class="btn-collapse" aria-label="Toggle Header">
      <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" stroke-width="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"></polyline></svg>
    </button>
  </header>
  <div class="legend" id="legend">
    <div class="badges">
      <span class="badge b-red">Violation</span>
      <span class="badge b-green">Event / Remedy</span>
      <span class="badge b-yellow">Perjury</span>
      <span class="badge b-orange">Judicial / Warn</span>
    </div>
    <div class="lg-sep"></div>
    <span class="lg-label">Key â€”</span>
    <div class="lg-item"><div class="lg-dot" style="background:#81322d"></div>4th/5th/6th Amend. Violation</div>
    <div class="lg-item"><div class="lg-dot" style="background:#3a4543"></div>Event / Remedy</div>
    <div class="lg-item"><div class="lg-dot" style="background:#ffe452;border-radius:50%"></div>Perjury</div>
    <div class="lg-item"><div class="lg-dot" style="background:#ff5025;border-radius:50%"></div>Judicial / Warning</div>
    <div class="lg-item"><div class="lg-dot" style="background:#5c201c"></div>Critical / Terminal</div>
    <div class="lg-item" style="margin-left:auto; font-weight:500;">
      <div class="lg-dot" style="background:var(--yellow);border-radius:50%;box-shadow:0 0 5px var(--yellow)"></div>
      Glowing nodes have attached media
    </div>
  </div>
</div>

<!-- ZOOM WIDGET -->
<div id="zoom-widget">
  <button class="zb" id="btn-in"  title="Zoom in (+)">+</button>
  <div class="z-level" id="z-label">100%</div>
  <button class="zb" id="btn-out" title="Zoom out (âˆ’)">âˆ’</button>
  <div class="z-sep"></div>
  <button class="zb" id="btn-fit" title="Fit to screen" style="font-size:13px">âŠ¡</button>
</div>

<!-- VIEWPORT + CANVAS -->
<div id="viewport">
  <div id="canvas">
    <div class="mermaid">
flowchart TB
    classDef violation fill:#81322d,stroke:#9e3e38,color:#f5d0ce,font-weight:bold
    classDef critical  fill:#5c201c,stroke:#81322d,color:#f5d0ce,font-weight:bold
    classDef event     fill:#3a4543,stroke:#4e5f5c,color:#d8e8e6
    classDef remedy    fill:#2a3230,stroke:#3a4543,color:#8aada8
    classDef perjury   fill:#222000,stroke:#c9b53f,color:#ffe452,font-weight:bold
    classDef judicial  fill:#1e0d00,stroke:#c93d1c,color:#ff8a6a,font-weight:bold
    classDef legal     fill:#2f3d3b,stroke:#3a4543,color:#8aada8
    classDef franks    fill:#81322d,stroke:#9e3e38,color:#f5d0ce
    classDef warn      fill:#1e0d00,stroke:#ff5025,color:#ff8a6a,font-weight:bold

    subgraph INCIDENT["ğŸ“ INCIDENT â€” Oct 30â€“31, 2023"]
        direction TB
        INC1["Alleged shots fired\nfrom Unit 203\nOct 30 evening"]
        INC2["Victims in Unit 104\nhome entire window\n1:30 PM â€“ 7:30 AM\nHear NOTHING"]
        INC3["3 bullet holes\ndiscovered in garage\nceiling + windshield"]
        INC4["Victim reports damage\n7:30 AM Oct 31"]
        INC5["ğŸ”´ ACOUSTIC IMPOSSIBILITY\n165 dB AR-15 indoors\nNo suppressor found\nZero witnesses citywide"]
        INC6["ğŸ”´ MISSING 3RD BULLET\nDispatch + LaFleur: 3 rounds\nProperty Inventory: 2 collected\nChain of custody destroyed"]
        INC1-->INC2-->INC3-->INC4
        INC3-->INC5
        INC3-->INC6
    end

    subgraph DISPATCH["ğŸ“¡ DISPATCH RECORD vs. AFFIDAVIT"]
        direction LR
        D1["ACTUAL DISPATCH\n8:22 AM â€” call received\n8:26 AM â€” dispatched\n8:33 AM â€” arrival\nEvent: SUSP, Priority 2"]
        D2["WACKER AFFIDAVIT\nPara 1 swears:\n'0730 AM dispatch'\n52-MINUTE FRAUD"]
        D3["ğŸ”´ FRANKS VIOLATION\nReckless disregard for truth\nMaterial false statement\nMust be excised"]
        D1 -->|"Contradicts"| D2-->D3
    end

    subgraph CONTACT["ğŸš” INITIAL POLICE CONTACT â€” 9:28 AM"]
        direction TB
        C1["Deputies emerge from\ntactical concealment\nbehind parked vehicles"]
        C2["Target confirmed:\nKyle Bigelow\n01:00:50"]
        C3["Staat BLITZES forward\nLeft hand concealed\nin jacket pocket\nFrames 1â€“8"]
        C4["Scene-control gesture:\nRight hand motions\nSteger to stand down"]
        C5["ğŸ”´ UNLAWFUL PAT-DOWN\n01:00:55â€“01:01:05\nStaat: 'I do it to everyone'\nNo individualized suspicion\nTerry v. Ohio violated"]
        C6["Direct accusation:\n'shots from YOUR apartment'\nFinger thrust at Bigelow\n01:01:14"]
        C7["Bigelow hesitates\n'Nothing in my house'\n01:01:23"]
        C8["ğŸ”´ LETHAL FORCE ESCALATION\nStaat snaps hand to holster\nrests palm on duty weapon\n01:01:25"]
        C9["Tactical encirclement\nJunkans closes from behind\n01:01:48"]
        C10["ğŸ”´ COERCED CONSENT\n'You can take a look'\nUnoverbome will\nSchneckloth violated\n01:01:54"]
        C11["Staat admits unit uncertainty\n'Maintenance might have\ngiven us the wrong one'\n01:02:07 â€” BEFORE ENTRY"]
        C1-->C2-->C3-->C4-->C5-->C6-->C7-->C8-->C9-->C10-->C11
    end

    subgraph SEARCH["ğŸ” CONSENT SEARCH â€” 9:28 AM to 12:27 PM"]
        direction TB
        subgraph SCOPE["Scope Violations â€” Arizona v. Hicks"]
            direction LR
            SV0["Stated scope:\n'Move some stuff around'\n'See if shots came from house'"]
            SV1["Moves phone after\nexplicit prohibition\n01:03:26â€“01:03:30"]
            SV2["Opens closed ottoman\nsearches interior\n01:03:30"]
            SV3["Opens printer paper trays\n01:05:21"]
            SV4["Removes sealed rifle bag\nfrom high shelf\n01:06:38"]
            SV5["ğŸ”´ Unzips sealed bag\nInspects + counts\nmagazines\n01:06:46â€“01:06:50"]
            SV0 -->|Violated by| SV1
            SV0 -->|Violated by| SV2
            SV0 -->|Violated by| SV3
            SV0 -->|Violated by| SV4
            SV4-->SV5
        end
        subgraph NOTHING["Purpose Fulfilled â€” Nothing Found"]
            direction LR
            N1["Junkans: 'Not seeing\nanything here'\n01:04:44"]
            N2["Staat confirms full\nunder-bed search\n01:05:24"]
            N3["Junkans: 'Nothing'\n01:06:30"]
            N4["ğŸ”´ PURPOSE FULFILLED\nSearch should TERMINATE\nArizona v. Hicks violated\nSearch continues anyway"]
            N1-->N2-->N3-->N4
        end
        subgraph RIFLE_DILEMMA["Fatal Rifle Search Dilemma"]
            direction TB
            RD1{"Was rifle search\nlegitimate?"}
            RD2["IF standard consent search:\nClosed bag cannot be opened\nBullet holes not inside bag\nNO JUSTIFICATION"]
            RD3["IF emergency gun search:\nDeputies LIED to Bigelow\nabout purpose of entry\nFraudulent consent void"]
            RD4["ğŸ”´ BOTH BRANCHES FATAL\nEither way: rifle and all\nevidence from bag is DEAD"]
            RD1-->RD2-->RD4
            RD1-->RD3-->RD4
        end
        subgraph COUNSEL_INVOKE["Post-Invocation Violations"]
            direction TB
            CI1["Bigelow invokes counsel\n'gonna call my lawyer'\n01:07:47\nEdwards v. Arizona"]
            CI2["All 3 deputies position\nbehind Bigelow +\neavesdrop on call"]
            CI3["ğŸ”´ PANAS INTERRUPTS\nATTORNEY CALL\n'What is right below\nthis apartment?'\n01:11:49"]
            CI4["Bigelow mutes call\nand answers â€” element\nof charged offense elicited"]
            CI5["ğŸ”´ POST-REVOCATION SEARCH\nStaat: 'It's gotta be\nwhere his bed is'\n01:08:38"]
            CI6["Junkans resumes questioning\nmoment call ends"]
            CI1-->CI2-->CI3-->CI4
            CI1-->CI5-->CI6
        end
        subgraph COMMANDEER["Home Commandeered"]
            direction TB
            CM1["Captain Panas arrives\nwith architectural blueprints"]
            CM2["Blueprint map conference\nheld INSIDE Bigelow's home\n01:09:00â€“01:09:48"]
            CM3["Cross-reference schematics\nwith interior position:\n'Is that the right map\nfor this actual address?'"]
            CM4["ğŸ”´ BEYOND McARTHUR\nHome used as forensic\ncommand post after\nconsent WITHDRAWN\nFlorida v. Jardines violated"]
            CM5["Geometric nexus\nconstructed during illegal\ncommand-post occupation"]
            CM1-->CM2-->CM3-->CM4-->CM5
        end
        SCOPE-->NOTHING
        NOTHING-->RIFLE_DILEMMA
        NOTHING-->COUNSEL_INVOKE
        COUNSEL_INVOKE-->COMMANDEER
    end

    subgraph ARREST["â›“ ARREST & CUSTODIAL DETENTION â€” 12:27 PM"]
        direction TB
        subgraph PC_ANALYSIS["Probable Cause at 12:27 PM"]
            direction LR
            PA1["Known facts at arrest:\nâ€¢ Proximity to unit\nâ€¢ Lawful rifle ownership\nâ€¢ Lives above garage"]
            PA2["NOT known at arrest:\nâ€¢ No shell casings\nâ€¢ No bullet holes in floor\nâ€¢ No trajectory analysis\nâ€¢ No forensic connection\nâ€¢ No witnesses\nâ€¢ Bigelow denied firing"]
            PA3["ğŸ”´ DUNAWAY VIOLATION\nProximity + lawful ownership\nâ‰  Probable Cause\nDunaway v. New York (1979)"]
            PA1-->PA3
            PA2-->PA3
        end
        subgraph DETENTION["Detention Conditions"]
            direction TB
            DT1["Handcuffed to wall\nSussex Substation"]
            DT2["5 hours without\nprescribed medications\nPTSD + panic disorder"]
            DT3["ğŸ”´ ADA Title II VIOLATION\nCity of SF v. Sheehan\nNo accommodation made"]
            DT4["ğŸ”´ 14th Amend. VIOLATION\nDeliberate indifference\nto medical needs\nCity of Revere (1983)"]
            DT5["ğŸ”´ EXCESSIVE FORCE\nCompliant, unarmed defendant\nKingsley v. Hendrickson (2015)"]
            DT6["North Face coat stripped\nnot inventoried or returned\nReleased into freezing temps"]
            DT1-->DT2-->DT3 & DT4 & DT5
            DT1-->DT6
        end
        subgraph CPS_WEAPON["CPS as Coercion Tool"]
            direction TB
            CP1["Girlfriend refuses to\nincriminate Bigelow\n'Eyes appeared to water'"]
            CP2["CPS contacted at 13:26\nDURING girlfriend interrogation"]
            CP3["LAP form scored: Low Danger\nSteger overrides to 'High Danger'\nbased solely on 'my belief'"]
            CP4["ğŸ”´ COERCION\nCPS used as leverage\nnot child safety\nColorado v. Connelly (1986)"]
            CP1-->CP2-->CP3-->CP4
        end
        subgraph PSYCH_WEAPON["51.15 Weaponization"]
            direction TB
            PW1["Bigelow invokes counsel\nwithdraws consent\nrefuses to confess"]
            PW2["Panas initiates Â§ 51.15\npsy commitment attempt"]
            PW3["Stated basis: Bigelow\n'believed he was only\nperson in apartment'"]
            PW4["ğŸ”´ FABRICATED BASIS\nVideo 01:02:12 shows Bigelow\nintroduced girlfriend + daughter\nimmediately upon contact"]
            PW5["ğŸ”´ RETALIATORY CONFINEMENT\nCrawford-El v. Britton\nTemporally follows rights invocation\nShocks the conscience"]
            PW1-->PW2-->PW3-->PW4-->PW5
        end
        PC_ANALYSIS-->DETENTION
        DETENTION-->CPS_WEAPON
        DETENTION-->PSYCH_WEAPON
    end

    subgraph INTERROGATION["ğŸ™ INTERROGATION SEQUENCE"]
        direction TB
        subgraph PRE_MIRANDA["Pre-Miranda Home Interrogation"]
            direction LR
            PM1["09:28 AM â€” contact begins\nBigelow surrounded in home\nby armed deputies"]
            PM2["Questions target offense elements:\nrifle access, last touch,\nhearing shots, apartment number"]
            PM3["Duration: 3h 47m\nwithout Miranda warnings"]
            PM4["ğŸ”´ CUSTODY STANDARD MET\nNo reasonable person would feel\nfree to terminate encounter\nBerkemer v. McCarty (1984)"]
            PM1-->PM2-->PM3-->PM4
        end
        subgraph SEIBERT_SEQ["Missouri v. Seibert Two-Step"]
            direction TB
            SS1["STEP 1: 3h 47m\nun-Mirandized home\ninterrogation exhausts suspect"]
            SS2["STEP 2: Handcuffed to\nwall 1 additional hour"]
            SS3["STEP 3: Miranda read\nat station â€” no meaningful\nbreak, same environment"]
            SS4["STEP 4: Formal recorded\ninterview overlaps home\ninterrogation content"]
            SS5["ğŸ”´ SEIBERT VIOLATION\nMid-interrogation warning\nnot effective\nEntire station interview\nSUPPRESSIBLE\nMissouri v. Seibert (2004)"]
            SS1-->SS2-->SS3-->SS4-->SS5
        end
        subgraph STATION_INT["Substation Recording Issues"]
            direction LR
            SI1["Visual recording\n'malfunctioned'"]
            SI2["Audio only captured\nNo video of:\nâ€¢ Restraint posture\nâ€¢ Pain manifestations\nâ€¢ Physical deterioration\nâ€¢ Officer conduct"]
            SI3["ğŸ”´ SPOLIATION\nWis. Stat. Â§ 968.073\nVisual record of voluntariness\neliminated\nAdverse inference warranted"]
            SI4["Bigelow transported\nto hospital immediately\npost-interview"]
            SI5["ğŸ”´ INVOLUNTARY STATEMENT\nER admission = not knowing,\nintelligent, voluntary waiver\nArizona v. Fulminante (1991)"]
            SI1-->SI2-->SI3
            SI4-->SI5
        end
        PRE_MIRANDA-->SEIBERT_SEQ
        SEIBERT_SEQ-->STATION_INT
    end

    subgraph WARRANTS["ğŸ“‹ WARRANT AFFIDAVIT ANALYSIS â€” Franks v. Delaware"]
        direction TB
        subgraph HOME_W["Home Search Warrant â€” Franks Matrix"]
            direction TB
            HW_HEAD["Detective Wacker drafts\nhome search warrant affidavit"]
            subgraph FALSE_STMTS["FALSE STATEMENTS â€” Must Be Excised"]
                direction LR
                FS1["âŒ Para 1: '0730 dispatch'\nActual: 0826\n52-minute fabrication"]
                FS2["âŒ Para 7: Spatial nexus\n'holes correspond to Unit 203'\nDerived from illegal entry\nâ€” fruit of poisonous tree"]
                FS3["âŒ Para 18: 'competitive shooter'\nFabricated Voigt attribution\nNot in recorded interview"]
                FS4["âŒ Para 21: June 2022 incident\nCharacterized as 'paranoid'\nActual: road rage victim\nWitnessed by Officer Nelson"]
                FS5["âŒ AR-15 in 'ready to fire'\nconfiguration â€” selector in Fire\nActual: standard safe storage\nMechanically required"]
            end
            subgraph OMISSIONS["MATERIAL OMISSIONS â€” Must Be Added"]
                direction LR
                OM1["âš  THREE negative search confirmations\nZero casings, odor, holes found\n15-min thorough search\nâ€” dissipates probable cause"]
                OM2["âš  Spatial nexus derived\nfrom illegal entry\nNot independent fact"]
                OM3["âš  Rifle found in storage config\nClosed case, high shelf\nLoaded mags stored inside"]
                OM4["âš  LaFleur trajectory:\n'quite a bit of slack'\n'could not accurately line it up'\n'general possible path' only"]
                OM5["âš  Zero shell casings found\nAnywhere in apartment\nZero odor of gunpowder"]
                OM6["âš  Acoustic impossibility:\nZero witnesses heard shots\nResidents home entire window"]
                OM7["âš  Consent withdrawal framed\nas 'non-cooperation'\nActual: rights invocation"]
            end
            HW_RECONSTRUCT["RECONSTRUCTED HONEST AFFIDAVIT:\n'We searched the exact origin point\nfor 15 mins, found ZERO evidence.\nNow we want a warrant to tear up the floor.'\nğŸ”´ NO MAGISTRATE ISSUES THIS WARRANT\nFishing expedition prohibited"]
            HW_HEAD-->FALSE_STMTS
            HW_HEAD-->OMISSIONS
            FALSE_STMTS-->HW_RECONSTRUCT
            OMISSIONS-->HW_RECONSTRUCT
        end
        subgraph PHONE_W["Cell Phone Warrant â€” Sixth Amendment Violation"]
            direction TB
            PW_HEAD["Voigt affidavit â€” Nov 20, 2023"]
            PW_PARA["Para 23 authorizes search for:\n'websites searched in reference to\ncovering up crime OR\nLEGAL REPRESENTATION for crime'"]
            PW_VIOL["ğŸ”´ FACIAL 6th AMENDMENT VIOLATION\nWarrant expressly targets\nattorney-client research\nEntire extraction VOID on its face"]
            PW_BRADY["Forensic binary extraction\ncaptures full iCloud backup\nCell phone video INSIDE\nState's extraction for 14 months"]
            PW_BRADY2["ğŸ”´ BRADY VIOLATION\nADA Zilavy Feb 6:\n'I've never seen the video'\nState possessed it 14 months\nBrady v. Maryland (1963)"]
            PW_MISREP["ğŸ”´ SCR 20:3.3 VIOLATION\nMisrepresentation to tribunal\nOLR referral warranted"]
            PW_HEAD-->PW_PARA-->PW_VIOL
            PW_HEAD-->PW_BRADY-->PW_BRADY2-->PW_MISREP
        end
    end

    subgraph FORENSICS["ğŸ”¬ FORENSIC INTEGRITY â€” Daubert Matrix"]
        direction LR
        subgraph F_SELECTOR["AR-15 Selector Switch"]
            FS_CLAIM["Niles report:\n'Selector in Fire position\nindicates hammer was\nforward after trigger pull'"]
            FS_TRUTH["SCIENTIFIC FACT:\nAR-15 mechanically CANNOT\nengage Safe when hammer down\nFire position = RESPONSIBLE\nSAFE STORAGE practice"]
            FS_VIOL["ğŸ”´ DAUBERT VIOLATION\nJunk science fabrication\nMust be excluded or\ndefended by qualified\nfirearms examiner"]
            FS_CLAIM-->FS_TRUTH-->FS_VIOL
        end
        subgraph F_GREEN["Green Tip Carpet Stain"]
            FG_CLAIM["Investigators report:\n'Green tint in carpet fibers'\n= M855 ammunition\nmatches rifle"]
            FG_TRUTH["M855 green paint layer:\nfractions of mm thick\nProjectile 3,000 fps through\nmultiple surfaces â€” vaporizes\nNo trace chemistry test done"]
            FG_VIOL["ğŸ”´ DAUBERT VIOLATION\nNo peer-reviewed methodology\nNo qualified expert identified\nNo controlled comparison tests\nInadmissible without\ntrace chemistry testimony"]
            FG_CLAIM-->FG_TRUTH-->FG_VIOL
        end
        subgraph F_TRAJ["Trajectory Analysis"]
            FT_CLAIM["LaFleur trajectory analysis\npresented as establishing\nbedroom-to-vehicle correspondence"]
            FT_METHOD["ACTUAL METHOD:\nStandard rod would not fit\nUsed flexible YARD FLAG wire\nAdmitted: 'quite a bit of slack'\nAdmitted: 'could not accurately\nline it up'\nResult: 'general possible path'"]
            FT_VIOL["ğŸ”´ DAUBERT VIOLATION\n1. No standard methodology\n2. Admitted known error rate\n3. Mechanical sag misrepresents\nlinear bullet physics"]
            FT_CLAIM-->FT_METHOD-->FT_VIOL
        end
        subgraph F_DNA["DNA Evidence"]
            FD_LOG["Bahr report:\nSwabs taken from rifle\n'DNA is on file'"]
            FD_GAP["Zero DNA results\nappear in discovery"]
            FD_REMEDY["ğŸ”´ MOTION TO COMPEL\nAdverse inference instruction\nif results not produced\nNegative = significant\nexculpatory evidence"]
            FD_LOG-->FD_GAP-->FD_REMEDY
        end
    end

    subgraph PERJURY["âš  DOCUMENTED PERJURY â€” Video vs. Testimony"]
        direction LR
        subgraph PJ_STAAT["Deputy Staat â€” 4 False Statements"]
            direction TB
            PS1["TESTIFIES: Did not say unit might be wrong\nVIDEO 01:02:06: 'Maintenance might have\ngiven us the wrong one'"]
            PS2["TESTIFIES: Did not touch defendant's phone\nVIDEO 01:03:26: Moves phone after\nexplicit prohibition"]
            PS3["TESTIFIES: Search ceased on revocation\nVIDEO 01:08:38: 'It's gotta be where\nhis bed is' â€” post-revocation"]
            PS4["TESTIFIES: Pat-down had individualized basis\nON VIDEO: 'I do it to everyone.\nIt's part of the job'"]
            PS1-->PS2-->PS3-->PS4
        end
        subgraph PJ_VOIGT["Detective Voigt â€” 2 Forums"]
            direction TB
            PV1["AFFIDAVIT Para 18:\n'Bigelow stated he is a\ncompetitive shooter'"]
            PV2["CROSS-EXAM ADMISSION:\n'may have been inferred'\nfrom 'like a competition rifle'\n+ 'used to have membership'"]
            PV3["PRELIMINARY HEARING:\nRepeats same fabricated\nattribution under oath"]
            PV4["ğŸ”´ GIGLIO VIOLATION\nFabricated attribution in\ntwo sworn forums"]
            PV1-->PV2-->PV3-->PV4
        end
        subgraph PJ_STEGER["Deputy Steger â€” Counsel Interference"]
            direction TB
            PE1["TESTIFIES:\n'Did you interfere with\ndefendant calling legal counsel?'\nAnswer: 'No'"]
            PE2["VIDEO 01:11:49:\nCapt. Panas interrupts\nattorney call while\nSteger present in room"]
            PE3["ğŸ”´ FALSE TESTIMONY\nSteger present during\ninterruption and fails\nto correct record"]
            PE1-->PE2-->PE3
        end
    end

    subgraph JUDICIAL["âš– JUDICIAL MISCONDUCT â€” Hon. J. Arthur Melvin III"]
        direction LR
        subgraph JM_FRANKS["Franks Framework Abandoned"]
            JF1["Court announces\nFranks hearing"]
            JF2["Applies standard:\n'Would I have issued\nthis warrant?'"]
            JF3["ğŸ”´ LEGALLY IMPERMISSIBLE\nReviewing court cannot\nretroactively issue warrant\nFranks 4-step analysis\nnever conducted"]
            JF1-->JF2-->JF3
        end
        subgraph JM_GOOGLE["Independent Investigation"]
            JG1["Court sua sponte\nconsults Google Street View\nduring deliberations"]
            JG2["Evidence not introduced\nby either party\nMagistrate never had it\nNot subject to cross-examination"]
            JG3["ğŸ”´ FOUR-CORNERS VIOLATION\nValidity assessed on\nwhat magistrate knew\nIllinois v. Gates (1983)"]
            JG1-->JG2-->JG3
        end
        subgraph JM_PROMPT["Prompted Voluntariness Finding"]
            JP1["Prosecutor asks court:\n'Was there anything about\nthe video that led the Court\nto believe statement was\nnot voluntary?'"]
            JP2["Court affirms prosecutor's\nframing â€” ruling delivered\nas response to leading question"]
            JP3["ğŸ”´ STRUCTURAL ERROR\nIndependent voluntariness\nfinding must address totality\nNot elicited by State's counsel"]
            JP1-->JP2-->JP3
        end
        subgraph JM_CARTRIDGE["Clear Factual Error"]
            JC1["Court ruling cites:\n'certainly some\nempty cartridges'"]
            JC2["Warrant Return:\n'spent rounds' from\nvictim's vehicle + garage\nâ€” NOT from Unit 203"]
            JC3["Wacker cross-exam:\n'I truly don't know\nwhere those were recovered'"]
            JC4["ğŸ”´ CLEARLY ERRONEOUS\nAnderson v. Bessemer City\nUniformly contradicted by\nevery relevant document"]
            JC1-->JC2-->JC3-->JC4
        end
        subgraph JM_FRUIT["Fruit Doctrine Misapplied"]
            JFR1["Court: 'Nothing to throw out\nbecause nothing was seized'"]
            JFR2["ğŸ”´ FUNDAMENTAL ERROR\nPhysical seizure NOT required\nfor suppressible fruits:\nâ€¢ Visual layout confirmation\nâ€¢ Bedroom spatial orientation\nâ€¢ Rifle existence confirmed\nAll observational fruits of\nillegal entry used in Para 7"]
            JFR1-->JFR2
        end
        subgraph JM_BIAS["Pattern of Bias â€” Â§ 971.20 Motion"]
            JB1["Every State objection sustained\nEvery defense objection overruled"]
            JB2["Court interrupts cross-examination\nto rehabilitate prosecution witnesses"]
            JB3["Consent search claims\nforeclosed before defendant heard"]
            JB4["Warrants heard in reverse\nchronological order â€” blocks\nWong Sun taint analysis"]
            JB5["ğŸ”´ BIAS SUFFICIENT FOR\nJUDGE SUBSTITUTION\nWis. Stat. Â§ 971.20"]
            JB1-->JB5
            JB2-->JB5
            JB3-->JB5
            JB4-->JB5
        end
    end

    subgraph SUPPRESS_CHAIN["âš¡ SUPPRESSION CASCADE â€” Wong Sun Chain"]
        direction TB
        SUP1["SUPPRESS:\nCoerced consent\n+ unlawful pat-down\nSchneckloth + Terry"]
        SUP2["SUPPRESS:\nAll fruits of consent search\nRifle, scope violations,\nnegative findings"]
        SUP3["SUPPRESS:\nPara 7 spatial nexus\nFruit of illegal entry\nWong Sun (1963)"]
        SUP4["SUPPRESS:\nHome search warrant\nFranks + dissipation +\nfruit excision"]
        SUP5["SUPPRESS:\nArrest at 12:27 PM\nDunaway â€” no PC at arrest"]
        SUP6["SUPPRESS:\nAll substation evidence\nFruit of Dunaway arrest\n+ Seibert two-step\n+ pre-Miranda statements"]
        SUP7["SUPPRESS:\nCell phone extraction\nFacial 6th Amend. violation\nEntire warrant void"]
        SUP8["SUPPRESS:\nPost-invocation statements\nEdwards + Massiah\nMaine v. Moulton (1985)"]
        SUP1-->SUP2-->SUP3-->SUP4-->SUP5-->SUP6
        SUP4-->SUP7
        SUP5-->SUP8
        RESULT["ğŸ”´ RESULT: RECONSTRUCTED AFFIDAVIT\nYIELDS ZERO PROBABLE CAUSE\n11 Independent Terminal Violations\nAny Single One Collapses the Case\nAll Together = Structural Error\nNot Amenable to Harmless-Error Review"]
        SUP6-->RESULT
        SUP7-->RESULT
        SUP8-->RESULT
    end

    subgraph REMEDIES["ğŸ“Œ REMEDIES & FORWARD STRATEGY"]
        direction TB
        subgraph IMMEDIATE["ğŸ—‚ Immediate Motions"]
            direction TB
            IM1["Motion for Reconsideration:\nâ€¢ Correct cartridge factual error\nâ€¢ Para 7 fruit argument\nâ€¢ Dispatch fraud (52-min)\nâ€¢ Google Street View error\nâ€¢ Franks not conducted\nâ€¢ Prompted voluntariness"]
            IM2["Motion for Judge Substitution:\nWis. Stat. Â§ 971.20\nOne-directional interventions\n+ independent investigation"]
            IM3["Motion to Compel DNA:\nAdverse inference instruction\nif results not produced"]
            IM4["Subpoena Mensah Files:\nRaw extraction data\nNeighbor phone results\nPre-departure communications"]
            IM1-->IM2-->IM3-->IM4
        end

        subgraph DAUBERT_MIL["ğŸ”¬ Daubert Motions in Limine"]
            direction TB
            DM1["Exclude Niles:\nAR-15 selector = junk science\nNo peer-reviewed basis"]
            DM2["Exclude Green Tip claim:\nNo trace chemistry basis\nNo methodology"]
            DM3["Exclude LaFleur trajectory:\nAdmitted inaccuracy fatal\nYard-flag wire not standard"]
            DM4["Crawford Issue:\nSubstitute expert cannot\nadopt LaFleur conclusions\nCrawford v. Washington (2004)"]
            DM1-->DM2-->DM3-->DM4
        end

        subgraph APPELLATE["ğŸ“‘ Appellate â€” 20 Preserved Grounds"]
            direction TB
            AP1["De Novo Review:\nFranks denied Â· Para 7 fruit\nDunaway arrest Â· Seibert\n6th Amend. phone warrant\nGoogle Street View\nPrompted voluntariness\n4th + 6th Amend. violations"]
            AP2["Clear Error Review:\nCartridge factual finding\nuniformly contradicted\nby entire record"]
            AP3["Abuse of Discretion:\nAR-15 selector Daubert\nGreen tip Daubert\nTrajectory Daubert"]
            AP1-->AP2-->AP3
        end

        subgraph CIVIL["âš– Civil & Collateral Actions"]
            direction TB
            CV1["42 U.S.C. Â§ 1983:\nUnlawful pat-down (Terry)\nCoerced consent (Schneckloth)\nCommandeered home (Jardines)\nWarrantless phone (Riley)\n1st Amend. recording (Glik)\n6th Amend. counsel (Edwards)\n4-hour family detention\nDunaway false arrest"]
            CV2["ADA Title II:\nCity of SF v. Sheehan\nFailed to accommodate\ndocumented disabilities"]
            CV3["Â§ 51.15 Abuse:\nCrawford-El v. Britton\nRetaliatory psy confinement\nCounty of Sacramento v. Lewis\nShocks the conscience"]
            CV4["Monell Liability:\nCapt. Panas â€” supervisory\nPost-revocation rifle seizure\nHome command post\nAttorney call interruption\nÂ§ 51.15 attempt"]
            CV5["Referrals:\nOLR â€” Zilavy SCR 20:3.3\nLESB â€” Voigt, Staat,\nPanas, Steger\nWis. Stat. Â§ 165.85"]
            CV1-->CV2-->CV3-->CV4-->CV5
        end

        IMMEDIATE-->DAUBERT_MIL
        DAUBERT_MIL-->APPELLATE
        APPELLATE-->CIVIL
    end

    INCIDENT-->DISPATCH
    DISPATCH-->CONTACT
    INCIDENT-->CONTACT
    CONTACT-->SEARCH
    SEARCH-->ARREST
    ARREST-->INTERROGATION
    SEARCH-->WARRANTS
    DISPATCH-->WARRANTS
    INTERROGATION-->WARRANTS
    WARRANTS-->FORENSICS
    FORENSICS-->PERJURY
    PERJURY-->JUDICIAL
    JUDICIAL-->SUPPRESS_CHAIN
    WARRANTS-->SUPPRESS_CHAIN
    ARREST-->SUPPRESS_CHAIN
    SEARCH-->SUPPRESS_CHAIN
    SUPPRESS_CHAIN-->REMEDIES

    class INC5,INC6,C5,C8,C10,SV5,N4,RD4,CI3,CI5,CM4,CM5 violation
    class PA3,DT3,DT4,DT5,CP4,PW5,PW_VIOL,PW_BRADY2,PW_MISREP violation
    class SS5,SI3,SI5,FS_VIOL,FG_VIOL,FT_VIOL,FD_REMEDY violation
    class PS1,PS2,PS3,PS4,PV4,PE3 perjury
    class JF3,JG3,JP3,JC4,JFR2,JB5 judicial
    class HW_RECONSTRUCT,RESULT critical
    class SUP1,SUP2,SUP3,SUP4,SUP5,SUP6,SUP7,SUP8 remedy
    class IM1,IM2,IM3,IM4,DM1,DM2,DM3,DM4,AP1,AP2,AP3,CV1,CV2,CV3,CV4,CV5 remedy
    class D3,FS1,FS2,FS3,FS4,FS5 franks
    class OM1,OM2,OM3,OM4,OM5,OM6,OM7 warn
    </div>
  </div>
</div>

<!-- MEDIA TOOLTIP -->
<div id="media-tooltip">
  <div class="tt-inner" id="tt-inner"></div>
</div>

<!-- HINT -->
<div id="hint">drag to pan Â· scroll / pinch to zoom</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ENGINE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
mermaid.initialize({
  startOnLoad: true,
  theme: 'base',
  themeVariables: {
    background:           '#0e1210',
    primaryColor:         '#3a4543',
    primaryTextColor:     '#d8e8e6',
    primaryBorderColor:   '#4e5f5c',
    secondaryColor:       '#1c211e',
    tertiaryColor:        '#161a18',
    lineColor:            '#d7d7cf',
    edgeLabelBackground:  '#1c211e',
    nodeTextColor:        '#d8e8e6',
    clusterBkg:           '#161a18',
    clusterBorder:        '#272c29',
    titleColor:           '#8a8880',
    fontFamily:           "'DM Mono',monospace",
    fontSize:             '12px',
  },
  flowchart: { curve: 'basis', htmlLabels: false, padding: 20, nodeSpacing: 44, rankSpacing: 52 }
});

const SHELL    = document.getElementById('shell');
const VP       = document.getElementById('viewport');
const CANVAS   = document.getElementById('canvas');
const ZW       = document.getElementById('zoom-widget');
const ZLABEL   = document.getElementById('z-label');
const HINT     = document.getElementById('hint');
const TOOLTIP  = document.getElementById('media-tooltip');
const TT_INNER = document.getElementById('tt-inner');

const MIN = 0.07, MAX = 10, STEP = 0.14;
let scale = 1, ox = 0, oy = 0, shellH = 0;

/* Resize Observer guarantees layout adjusts immediately upon header collapse */
const ro = new ResizeObserver(() => {
  shellH = SHELL.offsetHeight;
  VP.style.top    = shellH + 'px';
  VP.style.height = (window.innerHeight - shellH) + 'px';
  ZW.style.top    = shellH + 'px';
  clamp();
  commit(false);
});
ro.observe(SHELL);

/* Toggle Header Logic */
document.getElementById('btn-collapse').addEventListener('click', () => {
  SHELL.classList.toggle('collapsed');
});

/* 2D Transform explicitly used to force high-res rasterization on mobile */
function commit(animated) {
  if (animated) {
    CANVAS.style.transition = 'transform .26s cubic-bezier(.22,.61,.36,1)';
    setTimeout(() => { CANVAS.style.transition = ''; }, 300);
  }
  CANVAS.style.transform = `translate(${ox}px, ${oy}px) scale(${scale})`;
  ZLABEL.textContent = Math.round(scale * 100) + '%';
}

function fit() {
  const vw = VP.clientWidth, vh = VP.clientHeight;
  const cw = CANVAS.scrollWidth, ch = CANVAS.scrollHeight;
  if (!cw || !ch) return;
  const p = 40;
  scale = Math.max(MIN, Math.min(MAX, Math.min((vw - p * 2) / cw, (vh - p * 2) / ch, 1)));
  ox = (vw - cw * scale) / 2; oy = (vh - ch * scale) / 2;
  commit(true);
}

function zoomAt(ns, fx, fy) {
  ns = Math.max(MIN, Math.min(MAX, ns));
  const r = ns / scale;
  ox = fx + (ox - fx) * r; oy = fy + (oy - fy) * r;
  scale = ns;
  commit(false);
}

function clamp() {
  const vw = VP.clientWidth, vh = VP.clientHeight;
  const M  = 120;
  const cw = CANVAS.scrollWidth * scale; const ch = CANVAS.scrollHeight * scale;
  ox = Math.min(vw - M, Math.max(-cw + M, ox));
  oy = Math.min(vh - M, Math.max(-ch + M, oy));
}

let rafW = null;
VP.addEventListener('wheel', e => {
  e.preventDefault();
  if (rafW) return;
  rafW = requestAnimationFrame(() => {
    rafW = null;
    const r = VP.getBoundingClientRect();
    zoomAt(scale + (e.deltaY < 0 ? STEP : -STEP), e.clientX - r.left, e.clientY - r.top);
  });
}, { passive: false });

let dragging = false, dsx, dsy, dox, doy, rafD = null;
VP.addEventListener('mousedown', e => {
  if (e.button !== 0) return;
  dragging = true; dsx = e.clientX; dsy = e.clientY; dox = ox; doy = oy;
  VP.classList.add('grabbing');
});
window.addEventListener('mousemove', e => {
  if (!dragging || rafD) return;
  rafD = requestAnimationFrame(() => {
    rafD = null;
    ox = dox + (e.clientX - dsx); oy = doy + (e.clientY - dsy);
    CANVAS.style.transform = `translate(${ox}px, ${oy}px) scale(${scale})`;
  });
}, { passive: true });
window.addEventListener('mouseup', () => {
  if (!dragging) return;
  dragging = false; VP.classList.remove('grabbing');
  clamp(); commit(false);
});

/* Touch Logic with Built-in Tap Detection to solve mobile interactions safely */
let tc = {};
let pinchD0 = null, pinchS0 = 1, pinchFx = 0, pinchFy = 0;
let panTx = 0, panTy = 0, panOx = 0, panOy = 0;
let rafT = null, tapStart = null;

function dist2(a, b) { return Math.hypot(a.clientX - b.clientX, a.clientY - b.clientY); }
function mid2(a, b) {
  const r = VP.getBoundingClientRect();
  return { x: (a.clientX + b.clientX) / 2 - r.left, y: (a.clientY + b.clientY) / 2 - r.top };
}

VP.addEventListener('touchstart', e => {
  e.preventDefault(); // crucial to prevent viewport rubber-banding
  for (const t of e.changedTouches) tc[t.identifier] = { clientX: t.clientX, clientY: t.clientY };
  const ids = Object.keys(tc);
  if (ids.length === 2) {
    const [a, b] = ids.map(id => tc[id]);
    pinchD0 = dist2(a, b); pinchS0 = scale;
    const m = mid2(a, b); pinchFx = m.x; pinchFy = m.y;
    tapStart = null;
  } else if (ids.length === 1) {
    const t = tc[ids[0]];
    panTx = t.clientX; panTy = t.clientY; panOx = ox; panOy = oy;
    pinchD0 = null;
    tapStart = { x: t.clientX, y: t.clientY, time: Date.now() };
  }
}, { passive: false });

VP.addEventListener('touchmove', e => {
  e.preventDefault();
  for (const t of e.changedTouches) tc[t.identifier] = { clientX: t.clientX, clientY: t.clientY };
  if (rafT) return;
  rafT = requestAnimationFrame(() => {
    rafT = null;
    const ids = Object.keys(tc);
    if (ids.length === 2 && pinchD0 !== null) {
      const [a, b] = ids.map(id => tc[id]);
      const ns = Math.max(MIN, Math.min(MAX, pinchS0 * dist2(a, b) / pinchD0));
      const r = ns / scale;
      ox = pinchFx + (ox - pinchFx) * r; oy = pinchFy + (oy - pinchFy) * r;
      scale = ns;
    } else if (ids.length === 1) {
      const t = tc[ids[0]];
      ox = panOx + (t.clientX - panTx); oy = panOy + (t.clientY - panTy);
      if (tapStart && Math.hypot(t.clientX - tapStart.x, t.clientY - tapStart.y) > 8) {
        tapStart = null; 
        hideTT(); // Cleanly dismiss tooltips when dragging map
      }
    }
    CANVAS.style.transform = `translate(${ox}px, ${oy}px) scale(${scale})`;
    ZLABEL.textContent = Math.round(scale * 100) + '%';
  });
}, { passive: false });

VP.addEventListener('touchend', e => {
  const idsBefore = Object.keys(tc);
  for (const t of e.changedTouches) delete tc[t.identifier];
  const ids = Object.keys(tc);

  /* Manual tap detection evaluates interactions blocked by preventDefault */
  if (tapStart && idsBefore.length === 1 && ids.length === 0) {
    if ((Date.now() - tapStart.time) < 400) {
      const t = e.changedTouches[0];
      
      // Temporarily hide tooltip so raycast grabs the graphic node beneath
      const wasVis = TOOLTIP.classList.contains('vis');
      if (wasVis) TOOLTIP.style.display = 'none';
      const target = document.elementFromPoint(t.clientX, t.clientY);
      if (wasVis) TOOLTIP.style.display = '';

      const g = target ? target.closest('g.node') : null;
      if (g) {
        const raw = g.id || '';
        if (raw.startsWith('flowchart-')) {
          const parts = raw.replace(/^flowchart-/, '').split('-'); parts.pop();
          const nid = parts.join('_');
          if (mediaData[nid]) showTT(nid, t.clientX, t.clientY);
          else hideTT();
        } else { hideTT(); }
      } else { hideTT(); }
    }
  }

  if (ids.length === 1) {
    const t = tc[ids[0]];
    panTx = t.clientX; panTy = t.clientY; panOx = ox; panOy = oy;
    pinchD0 = null;
  }
  if (ids.length === 0) { clamp(); commit(false); }
}, { passive: true });

/* Button Actions */
const cx = () => VP.clientWidth  / 2, cy = () => VP.clientHeight / 2;
document.getElementById('btn-in') .addEventListener('click', () => zoomAt(scale + STEP, cx(), cy()));
document.getElementById('btn-out').addEventListener('click', () => zoomAt(scale - STEP, cx(), cy()));
document.getElementById('btn-fit').addEventListener('click', fit);

let hideTimer = null, curVid = null, rafTT = null, pendX, pendY;
let activeNodeId = null;

function highlightNode(nid) {
  document.querySelectorAll('g.node[data-nid]').forEach(g => {
    const n = g.getAttribute('data-nid');
    const shape = g.querySelector('rect,polygon,circle,ellipse');
    const hasM = !!mediaData[n];
    if (shape) {
      if (n === nid) shape.style.filter = hasM ? 'drop-shadow(0 0 9px rgba(255,228,82,.72)) brightness(1.18)' : 'brightness(1.14)';
      else shape.style.filter = hasM ? 'drop-shadow(0 0 5px rgba(255,228,82,.38))' : '';
    }
  });
}

function ttPos(x, y) {
  if (window.innerWidth <= 768) return; // Desktop only mapping
  const W = window.innerWidth, H = window.innerHeight;
  let lx = x + 18, ly = y - 20;
  if (lx + 340 > W - 8) lx = x - 340 - 18;
  if (ly + 280 > H - 8) ly = H - 280 - 8;
  TOOLTIP.style.setProperty('--ttx', Math.max(8, lx) + 'px');
  TOOLTIP.style.setProperty('--tty', Math.max(8, ly) + 'px');
}

function showTT(nodeId, x, y) {
  clearTimeout(hideTimer);
  TT_INNER.innerHTML = '';
  const m = mediaData[nodeId];
  if (!m) {
    TT_INNER.innerHTML = `<div class="tt-empty">No media attached<br><span style="font-size:9px;opacity:.35;">NODE: ${nodeId}</span></div>`;
  } else {
    let med = document.createElement(m.type === 'video' ? 'video' : 'img');
    med.className = 'tt-media'; med.src = m.url;
    if (m.type === 'video') {
      med.autoplay = true; med.muted = true; med.loop = true; med.controls = true; med.playsInline = true;
      curVid = med;
    } else {
      med.alt = m.caption || nodeId; med.decoding = 'async'; med.loading = 'lazy';
    }
    const cap = document.createElement('div');
    cap.className = 'tt-cap';
    cap.innerHTML = `<div class="tt-id">${nodeId}</div>${m.caption ? `<div>${m.caption}</div>` : ''}<div class="tt-hint-mobile">Tap empty space to close</div>`;
    TT_INNER.appendChild(med); TT_INNER.appendChild(cap);
  }
  ttPos(x, y);
  TOOLTIP.classList.add('vis');
  highlightNode(nodeId);
}

function hideTT() {
  hideTimer = setTimeout(() => {
    TOOLTIP.classList.remove('vis');
    if (curVid) { curVid.pause(); curVid = null; }
    setTimeout(() => { TT_INNER.innerHTML = ''; }, 200);
    highlightNode(null);
  }, 180);
}

TOOLTIP.addEventListener('mouseenter', () => clearTimeout(hideTimer));
TOOLTIP.addEventListener('mouseleave', hideTT);

window.addEventListener('mousemove', e => {
  pendX = e.clientX; pendY = e.clientY;
  if (!TOOLTIP.classList.contains('vis') || rafTT) return;
  rafTT = requestAnimationFrame(() => { rafTT = null; ttPos(pendX, pendY); });
}, { passive: true });

function postRender() {
  const svg = document.querySelector('.mermaid svg');
  if (!svg) return;
  svg.style.background = 'transparent'; svg.style.overflow = 'visible';

  svg.querySelectorAll('.edgePath path, .flowchart-link').forEach(p => p.style.cssText += 'stroke:#d7d7cf;stroke-width:1.3px;opacity:.52;');
  svg.querySelectorAll('marker path, marker polygon').forEach(p => p.style.fill = '#c5c5c3');
  svg.querySelectorAll('.cluster rect').forEach(r => r.style.cssText += 'fill:#161a18;stroke:#272c29;stroke-width:1px;');
  svg.querySelectorAll('.cluster-label text, .cluster-label span').forEach(l => l.style.cssText += "fill:#8a8880;font-family:'DM Mono',monospace;font-size:11px;");

  svg.querySelectorAll('g.node').forEach(g => {
    const raw = g.id || '';
    if (!raw.startsWith('flowchart-')) return;
    const parts = raw.replace(/^flowchart-/, '').split('-'); parts.pop();
    const nid = parts.join('_');
    g.setAttribute('data-nid', nid);
    g.style.cursor = 'pointer';

    const shape = g.querySelector('rect,polygon,circle,ellipse');
    const hasM = !!mediaData[nid];
    if (hasM && shape) {
      shape.style.filter = 'drop-shadow(0 0 5px rgba(255,228,82,.38))';
      shape.style.strokeWidth = '2px';
    }
    
    // Desktop hover handling (mobile touch intercept handles the rest)
    g.addEventListener('mouseenter', e => showTT(nid, e.clientX, e.clientY));
    g.addEventListener('mouseleave', () => hideTT());
  });

  fit();
  setTimeout(() => HINT.classList.add('gone'), 5000);
}

const obs = new MutationObserver((_, o) => {
  if (document.querySelector('.mermaid svg')) {
    o.disconnect();
    requestAnimationFrame(() => requestAnimationFrame(postRender));
  }
});
obs.observe(document.body, { childList: true, subtree: true });
setTimeout(() => { if (document.querySelector('.mermaid svg')) postRender(); }, 4000);

</script>
</body>
</html>
